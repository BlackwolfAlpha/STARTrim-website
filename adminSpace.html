<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STARTrimAdminBoard</title>
    <link rel="icon" type="image/x-icon" href="">
    <link rel="stylesheet" href="design/style.css">
</head>
<body>
    <div class="background">
        <div class="navbar">
            <div class="menu">
                <div class="logo">
                    <img src="design/Logos/startrimlogo.png" alt="STARTrim Logo">
                </div>
            </div>
        </div>

        <div class="admin-board">
            <h2>User Requests:</h2>
            <p>Please enter the admin code to access user requests:</p>
            <div id="userRequests">
                <p>Loading Data pls wait...</p>
            </div>
        </div>
    </div>

    <script>
        async function fetchDataFromGoogleSheet() {
            try {
                const response = await fetch('https://sheets.googleapis.com/v4/spreadsheets/1WrsrKtGqjdwbaL20Cs7TmScQNVp5kJRKcN0P6wHmdko/values/signupSTARTrim-form!A:I?key=AIzaSyAYSge_Rg_xblZbyj9vHdhMJzZOrGFylqI');
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                const data = await response.json();
                return data.values;
            } catch (error) {
                console.error('Error fetching data:', error.message);
                return null;
            }
        }

        async function blockRequest(requestId, row) {
            var requestDiv = document.getElementById(requestId);
            requestDiv.style.display = 'none';
            await deleteDataFromGoogleSheet(row);
        }

        async function deleteDataFromGoogleSheet(row) {
            try {
                const apiKey = 'AIzaSyAYSge_Rg_xblZbyj9vHdhMJzZOrGFylqI';
                const spreadsheetId = '1WrsrKtGqjdwbaL20Cs7TmScQNVp5kJRKcN0P6wHmdko';

                const range = `A${row}:I${row}`;

                const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}:clear?key=${apiKey}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error('Failed to delete data');
                }

                const responseData = await response.json();
                console.log('Deleted range:', responseData.clearedRange);
            } catch (error) {
                console.warn('Failed to delete data:', error.message);
            }
        }

        window.onload = async function() {
            const isAdmin = prompt("Please enter the admin code:");
            if (isAdmin === "Black23#GLaD") {
                const data = await fetchDataFromGoogleSheet();
                if (data) {
                    displayData(data);
                } else {
                    const userRequestsDiv = document.getElementById('userRequests');
                    userRequestsDiv.innerHTML = '<p>Error fetching data. Please try again later.</p>';
                }
            } else {
                const userRequestsDiv = document.getElementById('userRequests');
                userRequestsDiv.innerHTML = '<p>Unauthorized access. Please enter the correct admin code.</p>';
                redirectToHomePage();
            }
        }

        function redirectToHomePage() {
            window.location.href = 'STARTrimHOME.html';
        }

        function displayData(data) {
            var userRequestsDiv = document.getElementById('userRequests');
            userRequestsDiv.innerHTML = '';
            if (data.length > 1) {
                for (var i = 1; i < data.length; i++) {
                    var userData = data[i];
                    var isBlocked = userData[8] === 'true';
                    if (!isBlocked) {
                        var requestId = 'request_' + i;
                        var confirmationDiv = document.createElement('div');
                        confirmationDiv.id = requestId;
                        confirmationDiv.className = 'user-request';
                        confirmationDiv.innerHTML = `
                            <h3>User Request Confirmation</h3>
                            <p><strong>Email:</strong> ${userData[0]}</p>
                            <p><strong>Name:</strong> ${userData[1]} ${userData[2]}</p>
                            <p><strong>City:</strong> ${userData[4]}</p>
                            <p><strong>Age:</strong> ${userData[5]}</p>
                            <p><strong>About:</strong> ${userData[6]}</p>
                            <p><strong>Strengths:</strong> ${userData[7]}</p>
                            <p><strong>How they heard about us:</strong> ${userData[8]}</p>
                            <p><strong>Terms agreement:</strong> ${userData[9] ? 'Agreed' : 'Not agreed'}</p>
                            <button onclick="approveRequest('${requestId}')">Approve</button>
                            <button onclick="blockRequest('${requestId}', ${i})">Block</button>
                            <p>Your request has been received.</p>
                        `;
                        userRequestsDiv.appendChild(confirmationDiv);
                    }
                }
            } else {
                userRequestsDiv.innerHTML = '<p>No user requests found.</p>';
            }
        }

        function approveRequest(requestId) {
            var requestDiv = document.getElementById(requestId);
            var cells = requestDiv.querySelectorAll('p');
            var approvedText = 'Approved';
            cells.forEach(function(cell) {
                if (cell.textContent.includes('Terms agreement:')) {
                    var jCell = cell.nextElementSibling;
                    jCell.textContent = approvedText;
                }
            });
            requestDiv.style.display = 'none';
        }

    </script>
</body>
</html>
